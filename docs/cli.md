# LLMStruct CLI — Документация

## Оглавление
- [Введение](#введение)
- [Быстрый старт](#быстрый-старт)
- [Архитектура CLI](#архитектура-cli)
- [Основные команды](#основные-команды)
- [Модульная структура](#модульная-структура)
- [Примеры использования](#примеры-использования)
- [Best Practices](#best-practices)
- [FAQ](#faq)
- [Расширенные опции анализа дубликатов](#расширенные-опции-анализа-дубликатов)
- [Фильтрация файлов и директорий (обновлено)](#фильтрация-файлов-и-директорий-обновлено)

---

## Введение

CLI (`src/llmstruct/cli.py`) — основной интерфейс для работы с системой LLMStruct из командной строки. Он реализован как thin router: вся логика вынесена в модули (`src/llmstruct/modules/cli/`). Это обеспечивает чистоту, расширяемость и простоту поддержки.

---

## Быстрый старт

```bash
# Запуск CLI (пример)
python -m llmstruct.cli parse .
python -m llmstruct.cli query --prompt "Что делает этот проект?"
```

- Все команды CLI поддерживают `--help` для справки.
- Для большинства задач рекомендуется использовать модульные команды (см. ниже).

---

## Архитектура CLI

- **cli.py** — только роутер: парсит аргументы, вызывает функции из modules/cli.
- **modules/cli/** — вся бизнес-логика CLI-команд (parse, query, audit, copilot и др.).
- **ARCHIVE/** — устаревшие файлы, не используемые в новой архитектуре.

**Преимущества:**
- Легко расширять и тестировать отдельные команды.
- Нет дублирования логики.
- Быстрая поддержка новых фич.

---

## Основные команды

| Команда                | Описание                                      |
|------------------------|-----------------------------------------------|
| `parse`                | Парсинг кода и генерация struct.json          |
| `query`                | Запрос к LLM с контекстом                     |
| `context`              | Генерация context.json                        |
| `dogfood`              | Анализ dogfooding (заглушка/разработка)       |
| `review`               | LLM review кода (заглушка/разработка)         |
| `copilot`              | Интеграция Copilot и управление контекстом    |
| `audit`                | Аудит структуры проекта                       |
| `analyze-duplicates`   | Анализ дублирования функций                   |

**Пример справки:**
```bash
python -m llmstruct.cli --help
python -m llmstruct.cli parse --help
```

---

## Модульная структура

- Все команды реализованы в отдельных файлах в `modules/cli/`:
  - `parse.py`, `query.py`, `audit.py`, `copilot.py`, ...
- Для расширения CLI — добавь новый модуль и зарегистрируй его в `cli.py`.
- Старые файлы CLI перенесены в `ARCHIVE/` и не используются.

---

## Примеры использования

### Генерация структуры кода
```bash
python -m llmstruct.cli parse . -o struct.json --language python
```

### Запрос к LLM
```bash
python -m llmstruct.cli query --prompt "Опиши архитектуру проекта" --context struct.json
```

### Аудит проекта
```bash
python -m llmstruct.cli audit . --include-duplicates
```

### Copilot-интеграция
```bash
python -m llmstruct.cli copilot . status
python -m llmstruct.cli copilot . suggest --query "Как улучшить архитектуру?"
```

---

## Best Practices
- Используй только модульные команды — не редактируй cli.py напрямую.
- Для новых CLI-фич — создай модуль в `modules/cli/`.
- Архивируй устаревшие файлы в `ARCHIVE/`.
- Для сложных сценариев — используй workflow и context orchestrator.
- Проверяй справку команд через `--help`.

---

## FAQ

**Q:** Как добавить новую CLI-команду?
**A:** Создай модуль в `modules/cli/`, зарегистрируй в `cli.py` через импорт и добавь в парсер аргументов.

**Q:** Где искать старые реализации?
**A:** В папке `ARCHIVE/`.

**Q:** Как узнать, какие команды доступны?
**A:** `python -m llmstruct.cli --help`

---

## Расширенные опции анализа дубликатов

### Режимы поиска дубликатов

- `--deep-duplicates same-name` — глубокий анализ только для функций с одинаковыми именами (по умолчанию).
- `--deep-duplicates any-name` — сравнивает все функции между собой по телу (AST-хеш), даже если имена разные. **Может быть медленно на больших проектах!**
- `--no-prod-filter` — показать **все** дубликаты, включая те, что только в архиве/тестах (по умолчанию показываются только production-дубликаты).

**Пример:**
```bash
python -m llmstruct.cli audit . --include-duplicates --deep-duplicates any-name --no-prod-filter
python -m llmstruct.cli analyze-duplicates --deep-duplicates any-name --no-prod-filter
```

- В отчёте явно указывается, включён ли production-фильтр (`prod_filter_enabled`).
- Встроен whitelist стандартных имён (main, __init__, run, setup, teardown) — они не попадают в рекомендации.
- Дубликаты только в тестах/архиве не считаются проблемой.
- Можно фильтровать рекомендации по приоритету и количеству копий (`--priority`, `--threshold`).

### Важно
- Аргумент `--deep-duplicates` теперь принимает режим (строка), а не просто флаг!
- Старый вызов с `--deep-duplicates` без значения больше не работает.
- В режиме `any-name` возможны ложные срабатывания, если код отличается незначительно.

---

## Фильтрация файлов и директорий (обновлено)

- `--include` и `--exclude` — паттерны файлов (можно несколько раз или через запятую).
- `--include-dir` и `--exclude-dir` — строгая фильтрация по директориям (можно несколько раз или через запятую).
    - `--include-dir` — только указанные директории будут обработаны (жёсткое включение).
    - `--exclude-dir` — указанные директории будут полностью исключены.
    - Директории нормализуются: неважно, есть ли слэш или точка в начале.
    - Можно комбинировать с паттернами файлов.
- `--no-prod-filter` — отключает фильтрацию production-дубликатов для анализа (см. выше).

**Примеры:**
```bash
python -m llmstruct.cli parse . --include-dir src/llmstruct/,scripts/ --exclude-dir .ARCHIVE/,tests/
python -m llmstruct.cli parse . --include '*.py' --exclude-dir docs/ --exclude '*.md'
```

- Директории фильтруются до применения паттернов файлов.
- Исключения по умолчанию: `.ARCHIVE/`, `tests/`, `test/`, `archive/` (для анализа дубликатов и рекомендаций).

---

> Документация актуальна для архитектуры 2024+. Для legacy-CLI см. ARCHIVE/ 