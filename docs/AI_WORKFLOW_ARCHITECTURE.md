# Архитектура и стратегия управления AI Workflow и правилами в llmstruct

---

## 1. Общая схема хранения и использования правил

```
Cursor Settings (General → Rules for AI)
    │
    └──> .cursorrules (базовые правила, режимы, ссылки)
            │
            ├──> .cursor/rules/ (тематические правила: workflow, code-style, session-management и др.)
            │
            └──> data/ai_workflow.json (основной workflow, чек-листы, шаблоны, автоматизация для AI)
                    │
                    └──> docs/ONBOARDING_LLMSTRUCT.md, docs/BEST_PRACTICES_LLMSTRUCT.md (подробные инструкции для человека)
```

---

## 2. Роли и назначение файлов

- **Cursor Settings → General → Rules for AI**
  - Минимальный набор универсальных правил (режимы, логирование, ссылки на подробности).
  - Всегда в памяти AI, даже без доступа к проекту.

- **.cursorrules**
  - Базовые правила для AI: режимы, логирование, восстановление фокуса, ссылки на ai_workflow.json и .cursor/rules/.
  - Не перегружает контекст, служит "маяком" для AI.

- **.cursor/rules/**
  - Тематические markdown-файлы: workflow-modes.mdc, session-management.mdc, ai-capabilities.mdc, logging-and-retrospective.mdc, cli-commands.mdc и др.
  - Хранят расширенные правила, best practices, примеры команд, локальные соглашения.
  - Используются AI и человеком при работе в Cursor.

- **data/ai_workflow.json**
  - Главный источник правды для AI: этапы, чек-листы, шаблоны промтов, автоматизация, восстановление фокуса.
  - Содержит ссылки на все остальные файлы.
  - Используется AI для автоматизации и воспроизводимости.

- **docs/ONBOARDING_LLMSTRUCT.md, docs/BEST_PRACTICES_LLMSTRUCT.md**
  - Подробные инструкции, best practices, примеры CLI, советы для человека.
  - Ссылки на эти файлы есть во всех слоях.

---

## 3. Принципы минимизации дублирования и деградации контекста

- **Дублируются только базовые правила** (режимы, логирование, "сверяйся с ai_workflow.json").
- **Детали — только по ссылкам** (чтобы не перегружать контекст).
- **Везде делать явные ссылки**: где искать подробности, best practices, примеры.
- **AI всегда сверяется с ai_workflow.json** при старте, переключении задач, восстановлении фокуса.
- **Регулярные "checkpoints"**: AI сверяется с meta-log и ai_workflow.json.
- **Логируются все ключевые события** для восстановления истории.

---

## 4. Как AI и человек должны этим пользоваться

### Для AI:
- При старте работы — свериться с .cursorrules и ai_workflow.json.
- На каждом этапе — использовать чек-листы и шаблоны из ai_workflow.json.
- При потере фокуса — восстановить по meta-log и ai_workflow.json.
- Для расширенных правил — обращаться к .cursor/rules/.
- Для CLI-команд и best practices — обращаться к документации.

### Для человека:
- Использовать ONBOARDING и BEST_PRACTICES для понимания структуры и best practices.
- Для локальных соглашений и примеров — смотреть .cursor/rules/.
- Для автоматизации и сценариев — использовать prompts_collection.json и CLI.

---

## 5. Пример сценария восстановления фокуса и работы с правилами

1. AI теряет фокус (например, после долгой паузы).
2. AI читает последние события из meta-log.
3. AI сверяется с ai_workflow.json (раздел context_restore).
4. AI обновляет llm_context и attention_marker.
5. Если не хватает информации — AI ищет детали в .cursor/rules/ и документации.
6. AI продолжает работу с восстановленным фокусом.

---

## 6. Рекомендации для планирования эпика по внедрению и поддержке системы правил

- Описать цели: прозрачность, минимизация деградации, автоматизация, удобство для AI и человека.
- Зафиксировать структуру файлов и слоёв правил.
- Описать процесс обновления и ретроспективы (логирование ошибок, обновление правил).
- Протестировать сценарии восстановления фокуса, переключения задач, автоматизации.
- Регулярно проводить ревью и обновление правил.

---

## 7. Ссылки и навигация

- Основной workflow: data/ai_workflow.json
- Тематические правила: .cursor/rules/
- Документация: docs/ONBOARDING_LLMSTRUCT.md, docs/BEST_PRACTICES_LLMSTRUCT.md
- Промты и сценарии: prompts_collection.json
- Примеры CLI: .cursor/rules/cli-commands.mdc, ONBOARDING

---

## Важно!
- После завершения работы по эпику и перед архивированием или проверкой актуальности файлов обязательно дождитесь merge PR и обновления ветки develop (git pull). Это гарантирует, что все изменения попадут в основную ветку и не будут случайно утеряны при локальных действиях.

**Этот документ — основа для эпика по внедрению и поддержке системы правил и workflow. Все предложения и улучшения приветствуются!** 