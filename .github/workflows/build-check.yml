name: Build & Test Installation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  full-install-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install all dependencies (CRITICAL)
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        pip install -e ".[dev]"
        echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
        python -c "import ijson; print('‚úÖ ijson —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
        python -c "import aiohttp; print('‚úÖ aiohttp —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
        python -c "import click; print('‚úÖ click —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
    
    - name: Check Python syntax (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python —Ñ–∞–π–ª–æ–≤..."
        python -m py_compile src/llmstruct/*.py
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    
    - name: Check critical lint errors (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏..."
        flake8 src/llmstruct --select=E9,F63,F7,F82 --show-source --statistics
        echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç"
    
    - name: Test full package import (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π..."
        python -c "
        import llmstruct
        print('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        
        # –ü—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
        try:
            from llmstruct.cli import main
            print('‚úÖ CLI –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ùå CLI –º–æ–¥—É–ª—å: {e}')
            exit(1)
        
        try:
            from llmstruct.llm_client import LLMClient
            print('‚úÖ LLM Client –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ö†Ô∏è LLM Client: {e}')
        
        print('‚úÖ –ò–º–ø–æ—Ä—Ç –ø–∞–∫–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω')
        "
    
    - name: Test CLI help command (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É CLI..."
        python -m llmstruct --help
        echo "‚úÖ CLI —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    - name: Test CLI basic commands (NON-CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã CLI..."
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é docs –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç (–¥–ª—è –ª–æ–≥–æ–≤)
        mkdir -p docs
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º parse –Ω–∞ —Å–∞–º–æ–º –ø—Ä–æ–µ–∫—Ç–µ
        python -m llmstruct parse . -o test_output.json || {
          echo "‚ö†Ô∏è Parse –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ —ç—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ"
          exit 0
        }
        
        if [ -f "test_output.json" ]; then
            echo "‚úÖ Parse –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª"
            ls -la test_output.json
        else
            echo "‚ö†Ô∏è Parse –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        fi
        
        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CLI –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    
    - name: Check style warnings (NON-CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)..."
        flake8 src/llmstruct --max-line-length=88 --statistics || {
          echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ —Å—Ç–∏–ª—é, –Ω–æ —ç—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ"
        }
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Final validation (CRITICAL)
      run: |
        echo "üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        python -c "
        import sys
        import llmstruct
        
        print(f'Python version: {sys.version}')
        
        if hasattr(llmstruct, '__version__'):
            print(f'LLMStruct version: {llmstruct.__version__}')
        else:
            print('LLMStruct version: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
        
        print('‚úÖ –ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π!')
        " 