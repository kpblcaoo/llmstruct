name: Build & Test Installation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  full-install-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install all dependencies (CRITICAL)
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        pip install -e ".[dev]"
        echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
        python -c "import ijson; print('‚úÖ ijson —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
        python -c "import aiohttp; print('‚úÖ aiohttp —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
        python -c "import click; print('‚úÖ click —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
    
    - name: Check Python syntax (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python —Ñ–∞–π–ª–æ–≤..."
        python -m py_compile src/llmstruct/*.py
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    
    - name: Check critical lint errors (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏..."
        flake8 src/llmstruct --select=E9,F63,F7,F82 --show-source --statistics
        echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç"
    
    - name: Test full package import (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π..."
        python -c "
        import llmstruct
        print('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        
        # –ü—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
        try:
            from llmstruct.cli import main
            print('‚úÖ CLI –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ùå CLI –º–æ–¥—É–ª—å: {e}')
            exit(1)
        
        try:
            from llmstruct.llm_client import LLMClient
            print('‚úÖ LLM Client –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ö†Ô∏è LLM Client: {e}')
        
        print('‚úÖ –ò–º–ø–æ—Ä—Ç –ø–∞–∫–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω')
        "
    
    - name: Test CLI help command (CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É CLI..."
        python -m llmstruct --help
        echo "‚úÖ CLI —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    - name: Test CLI basic commands (NON-CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã CLI..."
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
        mkdir -p ci-logs
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º parse –Ω–∞ —Å–∞–º–æ–º –ø—Ä–æ–µ–∫—Ç–µ
        echo "=== CLI Parse Test ===" > ci-logs/cli-test.log
        python -m llmstruct parse . -o test_output.json 2>&1 | tee -a ci-logs/cli-test.log || {
          echo "‚ö†Ô∏è Parse –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ —ç—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ" | tee -a ci-logs/cli-test.log
          echo "FAILED" > ci-logs/cli-status.txt
          exit 0
        }
        if [ -f "test_output.json" ]; then
            echo "‚úÖ Parse –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª" | tee -a ci-logs/cli-test.log
            ls -la test_output.json | tee -a ci-logs/cli-test.log
            echo "SUCCESS" > ci-logs/cli-status.txt
        else
            echo "‚ö†Ô∏è Parse –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º" | tee -a ci-logs/cli-test.log
            echo "PARTIAL" > ci-logs/cli-status.txt
        fi
        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CLI –∑–∞–≤–µ—Ä—à–µ–Ω–æ" | tee -a ci-logs/cli-test.log

    - name: Validate test_output.json (CRITICAL)
      run: |
        if [ -f "test_output.json" ]; then
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å test_output.json..."
          python -c "import json; json.load(open('test_output.json'))" && \
            echo "‚úÖ test_output.json –≤–∞–ª–∏–¥–µ–Ω" || \
            (echo "‚ùå test_output.json –ù–ï–≤–∞–ª–∏–¥–µ–Ω" && exit 1)
        else
          echo "‚ùå test_output.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å"
          exit 1
        fi
    
    - name: Check style warnings (NON-CRITICAL)
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)..."
        
        # –°–æ–∑–¥–∞–µ–º –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª—è
        echo "=== Style Check ===" > ci-logs/style-check.log
        flake8 src/llmstruct --max-line-length=88 --statistics 2>&1 | tee -a ci-logs/style-check.log || {
          echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ —Å—Ç–∏–ª—é, –Ω–æ —ç—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ" | tee -a ci-logs/style-check.log
          echo "WARNINGS" > ci-logs/style-status.txt
          exit 0
        }
        echo "SUCCESS" > ci-logs/style-status.txt
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" | tee -a ci-logs/style-check.log
    
    - name: Final validation (CRITICAL)
      run: |
        echo "üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        python -c "
        import sys
        import llmstruct
        
        print(f'Python version: {sys.version}')
        
        if hasattr(llmstruct, '__version__'):
            print(f'LLMStruct version: {llmstruct.__version__}')
        else:
            print('LLMStruct version: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
        
        print('‚úÖ –ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π!')
        " 
    
    - name: Write job summary
      if: always()
      run: |
        echo "## üìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ CI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üß™ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "ci-logs/cli-status.txt" ]; then
          CLI_STATUS=$(cat ci-logs/cli-status.txt)
          echo "- üîß CLI —Ç–µ—Å—Ç—ã: $CLI_STATUS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- üîß CLI —Ç–µ—Å—Ç—ã: –ù–ï –ó–ê–ü–£–°–ö–ê–õ–ò–°–¨" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "ci-logs/style-status.txt" ]; then
          STYLE_STATUS=$(cat ci-logs/style-status.txt)
          echo "- üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è: $STYLE_STATUS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è: –ù–ï –ó–ê–ü–£–°–ö–ê–õ–ê–°–¨" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "test_output.json" ]; then
          python -c "import json; json.load(open('test_output.json'))" && \
            echo '- üóÇÔ∏è test_output.json: –í–ê–õ–ò–î–ï–ù' >> $GITHUB_STEP_SUMMARY || \
            echo '- üóÇÔ∏è test_output.json: –ù–ï–í–ê–õ–ò–î–ï–ù' >> $GITHUB_STEP_SUMMARY
        else
          echo '- üóÇÔ∏è test_output.json: –ù–ï –°–û–ó–î–ê–ù' >> $GITHUB_STEP_SUMMARY
        fi
        echo '' >> $GITHUB_STEP_SUMMARY
        echo 'üìÅ –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Artifacts.' >> $GITHUB_STEP_SUMMARY

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()  # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–ª–æ
      with:
        name: ci-test-results
        path: |
          ci-logs/
          test_output.json
        retention-days: 30
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç
    - name: Summary of non-critical tests
      if: always()
      run: |
        echo "üìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–º —Ç–µ—Å—Ç–∞–º:"
        echo "=================================="
        
        if [ -f "ci-logs/cli-status.txt" ]; then
          CLI_STATUS=$(cat ci-logs/cli-status.txt)
          echo "üîß CLI —Ç–µ—Å—Ç—ã: $CLI_STATUS"
        else
          echo "üîß CLI —Ç–µ—Å—Ç—ã: –ù–ï –ó–ê–ü–£–°–ö–ê–õ–ò–°–¨"
        fi
        
        if [ -f "ci-logs/style-status.txt" ]; then
          STYLE_STATUS=$(cat ci-logs/style-status.txt)
          echo "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è: $STYLE_STATUS"
        else
          echo "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è: –ù–ï –ó–ê–ü–£–°–ö–ê–õ–ê–°–¨"
        fi
        
        echo "=================================="
        echo "üìÅ –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Artifacts" 