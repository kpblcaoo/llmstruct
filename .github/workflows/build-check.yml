name: Build & Test Installation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  full-install-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install all dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        pip install -e ".[dev]"
        echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Check Python syntax
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python —Ñ–∞–π–ª–æ–≤..."
        python -m py_compile src/llmstruct/*.py
        echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    
    - name: Check critical lint errors
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏..."
        flake8 src/llmstruct --select=E9,F63,F7,F82 --show-source --statistics
        echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç"
    
    - name: Test full package import
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π..."
        python -c "
        import llmstruct
        print('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        
        # –ü—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
        try:
            from llmstruct.cli import main
            print('‚úÖ CLI –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ö†Ô∏è CLI –º–æ–¥—É–ª—å: {e}')
        
        try:
            from llmstruct.llm_client import LLMClient
            print('‚úÖ LLM Client –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
        except Exception as e:
            print(f'‚ö†Ô∏è LLM Client: {e}')
        
        print('‚úÖ –ò–º–ø–æ—Ä—Ç –ø–∞–∫–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω')
        "
    
    - name: Test CLI help command
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É CLI..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ CLI –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
        python -c "from llmstruct.cli import main; print('‚úÖ CLI –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É help
        python -m llmstruct --help || {
          echo "‚ùå CLI --help failed, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
          python -c "
          try:
              import llmstruct
              print('‚úÖ llmstruct –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
              from llmstruct.cli import main
              print('‚úÖ CLI main –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')
          except Exception as e:
              print(f'‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}')
              import traceback
              traceback.print_exc()
          "
          exit 1
        }
        
        echo "‚úÖ CLI —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    - name: Test CLI basic commands
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã CLI..."
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        mkdir -p test_project
        cd test_project
        echo "print('hello')" > test.py
        
        # –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        python -m llmstruct parse . -o test_output.json || echo "‚ö†Ô∏è Parse command failed"
        
        if [ -f "test_output.json" ]; then
            echo "‚úÖ Parse –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª"
            ls -la test_output.json
        else
            echo "‚ö†Ô∏è Parse –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ —Ñ–∞–π–ª"
        fi
        
        cd ..
        echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CLI –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    
    - name: Check style warnings
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)..."
        flake8 src/llmstruct --max-line-length=88 --statistics || {
          echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ —Å—Ç–∏–ª—é, –Ω–æ —ç—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ"
        }
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Final validation
      run: |
        echo "üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        python -c "
        import sys
        import llmstruct
        
        print(f'Python version: {sys.version}')
        
        if hasattr(llmstruct, '__version__'):
            print(f'LLMStruct version: {llmstruct.__version__}')
        else:
            print('LLMStruct version: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
        
        print('‚úÖ –ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π!')
        " 